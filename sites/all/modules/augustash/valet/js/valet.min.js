(function(e){Drupal.behaviors.valet={once:false,open:false,links:false,results:false,weight:false,selected:false,requestTerm:"",valetSelector:"",valetSearchSelector:"",attach:function(t,n){if(Drupal.behaviors.valet.once)return;Drupal.behaviors.valet.once=true;Drupal.behaviors.valet.valetSelector=e("#valet");Drupal.behaviors.valet.valetSearchSelector=e("#valet-search");Drupal.behaviors.valet.valetSelector.hide();if(!Drupal.settings.valet.purge){Lawnchair({name:"valet"},function(){this.get("links",function(e){Drupal.behaviors.valet.links=e!="undefined"?e:false});this.get("weight",function(e){Drupal.behaviors.valet.weights=e!="undefined"?e:false})})}if(!Drupal.behaviors.valet.links){e.ajax({url:Drupal.settings.basePath+"valet/lookup",dataType:"json",success:function(e){Lawnchair({name:"valet"},function(){this.remove("links");this.save(e);Drupal.behaviors.valet.links=e})}})}Drupal.behaviors.valet.valetSearchSelector.autocomplete({minLength:2,delay:0,autoFocus:true,appendTo:"#valet-results",source:function(e,t){Drupal.behaviors.valet.resultsFilter(e.term);t(Drupal.behaviors.valet.results)},focus:function(e,t){Drupal.behaviors.valet.selected=t.item;Drupal.behaviors.valet.childrenCheck();return false},select:function(e,t){if(t.item){Drupal.behaviors.valet.go(t.item.label,t.item.value);return false}}}).data("autocomplete")._renderItem=function(t,n){var r=Drupal.behaviors.valet.shortcut(n.value);var i=Drupal.behaviors.valet.children(n);var s=n.value.length>85?n.value.substring(0,85)+"...":n.value.length>0?n.value:"/";return e("<li></li>").data("item.autocomplete",n).append("<a><strong>"+n.label+"</strong><br><em>"+s+"</em>"+i+r+"</a>").appendTo(t)};e(document).bind("keydown",Drupal.settings.valet.modifier+"+"+Drupal.settings.valet.key,function(){Drupal.behaviors.valet.show();return false});e(document).bind("keydown","esc",function(){Drupal.behaviors.valet.hide()});Drupal.behaviors.valet.valetSearchSelector.bind("keydown","esc",function(){Drupal.behaviors.valet.hide()});Drupal.behaviors.valet.valetSearchSelector.bind("keydown",Drupal.settings.valet.modifier,function(){Drupal.behaviors.valet.childrenCreate();return false});e(document).click(function(){Drupal.behaviors.valet.hide()});e("#valet-search-form").submit(function(){return false})},resultsFilter:function(t){Drupal.behaviors.valet.requestTerm=t;var n=e.ui.autocomplete.filter(Drupal.behaviors.valet.links.items,Drupal.behaviors.valet.requestTerm);Drupal.behaviors.valet.results=n.slice(0,4);if(Drupal.behaviors.valet.weights&&Drupal.behaviors.valet.weights[Drupal.behaviors.valet.requestTerm]){var r=Drupal.behaviors.valet.weights[Drupal.behaviors.valet.requestTerm];for(var i=0;i<Drupal.behaviors.valet.results.length;i++){if(r[Drupal.behaviors.valet.results[i].value]){Drupal.behaviors.valet.results[i].weight=r[Drupal.behaviors.valet.results[i].value]}else{Drupal.behaviors.valet.results[i].weight=0}}}Drupal.behaviors.valet.results.sort(Drupal.behaviors.valet.weightSort)},go:function(t,n){Drupal.behaviors.valet.goSave(n);if(n=="devel/cache/clear")n="devel/cache/clear?destination="+window.location.pathname.substring(1);if(n=="devel/ambit/clear")n="devel/ambit/clear?destination="+window.location.pathname.substring(1);if(n.indexOf("valet/cache/clear")!=-1)n+="?destination="+window.location.pathname.substring(1);var r=t.replace(/<\/?[a-z][a-z0-9]*[^<>]*>/ig,"");r=r.length>28?r.substring(0,28)+"...":r;var i=n.length>40?n.substring(0,40)+"...":n.length>0?n:"/";e("#valet-results").hide();Drupal.behaviors.valet.valetSelector.addClass("loading");e("#valet-loading-info").text(r);e("#valet-loading-value span").text(i);window.location=Drupal.settings.basePath+n},goSave:function(e){Lawnchair({name:"valet"},function(){var t=this;this.get("weight",function(t){if(!t){t={key:"weight"}}if(!t[Drupal.behaviors.valet.requestTerm]){t[Drupal.behaviors.valet.requestTerm]={}}t[Drupal.behaviors.valet.requestTerm][e]=t[Drupal.behaviors.valet.requestTerm][e]?t[Drupal.behaviors.valet.requestTerm][e]+1:1;this.save(t)})})},show:function(){Drupal.behaviors.valet.open=true;Drupal.behaviors.valet.valetSelector.fadeIn("normal");Drupal.behaviors.valet.valetSearchSelector.focus()},hide:function(){Drupal.behaviors.valet.open=false;Drupal.behaviors.valet.valetSelector.fadeOut("fast");Drupal.behaviors.valet.valetSearchSelector.unbind("keydown","1");Drupal.behaviors.valet.valetSearchSelector.unbind("keydown","2");Drupal.behaviors.valet.valetSearchSelector.unbind("keydown","3")},children:function(e){if(e.children){return'<span class="valet-icon valet-icon-'+Drupal.settings.valet.modifier.toLowerCase()+'"></span>'}return""},childrenCheck:function(e){var e=Drupal.behaviors.valet.selected;Drupal.behaviors.valet.childrenRemove()},childrenCreate:function(){var t=Drupal.behaviors.valet.selected;if(t.children&&!t.child){if(e(".valet-child").length)return;var n=e("#ui-active-menuitem").parent();for(var r=0;r<t.children.length;r++){var i=t.children[r];i.child=true;i.weight=r;var s="";if(r==0)s+=" first";if(r==t.children.length-1)s+=" last";var o=e('<li class="ui-menu-item valet-child'+s+'" role="menuitem"></li>').data("item.autocomplete",i).append("<a>"+i.label+"</a>");n.after(o);n=o;var u=o.height();o.css({height:0}).animate({height:u},300)}}},childrenRemove:function(){var t=Drupal.behaviors.valet.selected;var n=e(".valet-child");if(!t.child&&n.length){n.animate({height:0},300,function(){e(this).remove()})}},shortcut:function(e){var t="";switch(e){case Drupal.behaviors.valet.results[0]["value"]:t="return";break;case Drupal.behaviors.valet.results[1]["value"]:t="1";break;case Drupal.behaviors.valet.results[2]["value"]:t="2";break;case Drupal.behaviors.valet.results[3]["value"]:t="3";break}var n=parseInt(t);if(n){Drupal.behaviors.valet.valetSearchSelector.unbind("keydown",t);Drupal.behaviors.valet.valetSearchSelector.bind("keydown",t,function(){Drupal.behaviors.valet.go(Drupal.behaviors.valet.results[n]["label"],Drupal.behaviors.valet.results[n]["value"])})}return t?'<span class="valet-icon valet-icon-'+t+'"><span>':""},weightSort:function(t,n){if(t.weight>n.weight)return-1;if(t.weight<n.weight)return 1;return 0}}})(jQuery)